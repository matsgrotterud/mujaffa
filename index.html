<html lang="no">
<head>
  <meta charset="UTF-8" />
  <title>Mujaffa</title>

  <!-- Ruffle config: autoplay uten play-overlay -->
  <script>
    window.RufflePlayer = window.RufflePlayer || {};
    window.RufflePlayer.config = {
      autoplay: "on",
      unmuteOverlay: "hidden"
    };
  </script>

  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }

    #game-wrapper {
      width: 100%;
      height: 100vh;
      position: relative;
      background: #000;
    }

    #game {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    ruffle-player {
      width: 100%;
    }
    @media (min-width: 768px) {
      ruffle-player {
        width: 100%;
        height: 100%;
      }
    }

    button {
      border-radius: 999px;
      border: 1px solid #666;
      background: rgba(10,10,10,0.9);
      color: #eee;
      font-size: 14px;
      cursor: pointer;
    }

    /* INTRO */

    #intro-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, #3d3d3d 0, #000 55%, #000 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 16px;
      z-index: 9999;
      transition: opacity .5s ease;
    }

    #intro-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    #intro-overlay h2 {
      font-size: 24px;
      margin-bottom: 8px;
      text-transform: uppercase;
    }

    /* TOP BUTTONS */

    #top-buttons {
      position: fixed;
      top: 8px;
      left: 0;
      right: 0;
      padding: 0 10px;
      display: flex;
      justify-content: space-between;
      z-index: 50;
      pointer-events: none;
    }

    #top-buttons button {
      pointer-events: auto;
      padding: 6px 10px;
      font-size: 12px;
    }

    /* TOUCH CONTROLS */

    #touch-controls {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 10px;
      z-index: 40;
      background: linear-gradient(to top, rgba(0,0,0,.95), transparent);
      display: flex;
      justify-content: center;
    }

    #touch-controls-inner {
      width: 100%;
      max-width: 480px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 64px);
      gap: 8px;
    }

    #touch-controls-inner button {
      width: 100%;
      height: 100%;
      border-radius: 16px;
      font-size: 22px;
      border: 1px solid #444;
      background: rgba(15,15,15,.95);
    }

    .btn-arrow { font-size: 24px; }

    @media (min-width: 768px) {
      #touch-controls { display: none; }
    }
  </style>
</head>

<body>

  <div id="intro-overlay">
    <h2>Frem med pikken</h2>
    <p>Her har'u Mujaffa</p>
  </div>

  <div id="top-buttons">
    <button data-key="KeyH">H</button>
    <button data-key="KeyB">B</button>
  </div>

  <div id="game-wrapper">
    <div id="game"></div>
  </div>

  <div id="touch-controls">
    <div id="touch-controls-inner">

      <!-- TOP -->
      <button data-key="KeyX">üçÜ</button>
      <button class="btn-arrow" data-key="ArrowUp">‚ñ≤</button>
      <button data-key="KeyZ">üëã</button>

      <!-- BOTTOM -->
      <button class="btn-arrow" data-key="ArrowLeft">‚óÄ</button>
      <button class="btn-arrow" data-key="ArrowDown">‚ñº</button>
      <button class="btn-arrow" data-key="ArrowRight">‚ñ∂</button>

    </div>
  </div>

<script>
window.addEventListener("load", () => {

  const ruffle = window.RufflePlayer?.newest();
  const player = ruffle.createPlayer();
  const container = document.getElementById("game");

  container.appendChild(player);
  player.load("games/mujaffa.swf");

  player.tabIndex = 0;
  player.focus();

  const virtualKeyMap = {
    ArrowLeft:{key:"ArrowLeft",code:"ArrowLeft",keyCode:37},
    ArrowUp:{key:"ArrowUp",code:"ArrowUp",keyCode:38},
    ArrowRight:{key:"ArrowRight",code:"ArrowRight",keyCode:39},
    ArrowDown:{key:"ArrowDown",code:"ArrowDown",keyCode:40},
    KeyZ:{key:"z",code:"KeyZ",keyCode:90},
    KeyX:{key:"x",code:"KeyX",keyCode:88},
    KeyH:{key:"h",code:"KeyH",keyCode:72},
    KeyB:{key:"b",code:"KeyB",keyCode:66}
  };

  function sendKey(type, code) {
    const i = virtualKeyMap[code];
    if (!i) return;
    const e = new KeyboardEvent(type,{
      key:i.key,
      code:i.code,
      keyCode:i.keyCode,
      which:i.keyCode,
      bubbles:true
    });
    window.dispatchEvent(e);
    player.dispatchEvent(e);
    player.focus();
  }

  // ‚ùó Kun mobil / sm√• skjermer skal ha touch-sensitivitet
  const isMobileLike = window.matchMedia("(max-width: 767px)").matches;

  if (isMobileLike) {
    const HOLD_DELAY_MS = 900;
    const ARROW_CODES = {ArrowLeft:1,ArrowRight:1,ArrowUp:1,ArrowDown:1};
    const arrowState = {};

    document.querySelectorAll("button[data-key]").forEach(btn => {
      const code = btn.dataset.key;
      const isArrow = ARROW_CODES[code];

      if (isArrow && !arrowState[code])
        arrowState[code] = {isDown:false,holdTimeout:null};

      btn.addEventListener("touchstart", e => {
        e.preventDefault();
        if (!isArrow) {
          // X/Z/H/B p√• touch
          return sendKey("keydown", code);
        }

        const s = arrowState[code];
        if (s.isDown || s.holdTimeout) return;

        s.holdTimeout = setTimeout(() => {
          sendKey("keydown", code);
          s.isDown = true;
          s.holdTimeout = null;
        }, HOLD_DELAY_MS);
      }, {passive:false});

      btn.addEventListener("touchend", e => {
        e.preventDefault();
        if (!isArrow) {
          return sendKey("keyup", code);
        }

        const s = arrowState[code];
        if (s.holdTimeout) {
          clearTimeout(s.holdTimeout);
          s.holdTimeout = null;
          // kort tap ‚Üí kort pulse
          sendKey("keydown", code);
          sendKey("keyup", code);
        } else if (s.isDown) {
          sendKey("keyup", code);
          s.isDown = false;
        }
      }, {passive:false});

      btn.addEventListener("touchcancel", e => {
        e.preventDefault();
        if (!isArrow) return;
        const s = arrowState[code];
        if (s.holdTimeout) {
          clearTimeout(s.holdTimeout);
          s.holdTimeout = null;
        }
        if (s.isDown) {
          sendKey("keyup", code);
          s.isDown = false;
        }
      }, {passive:false});
    });
  }

  setTimeout(() => {
    document.getElementById("intro-overlay").classList.add("hidden");
  }, 3000);

});
</script>

</body>
</html>